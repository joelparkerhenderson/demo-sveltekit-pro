# Demo SvelteKit: Lucia authentication

Setup created a demo route for Lucia:

* http://localhost:5173/demo/lucia

Setup created a Lucia demo directory.

```sh
ls -1 src/routes/demo/lucia/
```

```sh
src/routes/demo/lucia/
src/routes/demo/lucia//+page.server.ts
src/routes/demo/lucia//+page.svelte
src/routes/demo/lucia//login
src/routes/demo/lucia//login/+page.server.ts
src/routes/demo/lucia//login/+page.svelte
```

Browse: http://localhost:5173/demo/lucia/login


### Display error messages

We prefer Lucia to display error messages that originate from the database and ORM.

The Lucia login and registration code is in the file [`src/routes/demo/lucia/login/+page.server.ts`](src/routes/demo/lucia/login/+page.server.ts).

Change the failure message line.

From:

```ts
return fail(500, { message: 'An error has occurred' });
```

Into:

```ts
return fail(500, { message: 'An error has occurred: ' + (e instanceof Error ? e.message : 'unknown error') });
```

Browse: http://localhost:5173/demo/lucia/login

Now if you try username "alice" and password "secret", you should see this error message: 

* An error has occurred: cannot insert a non-DEFAULT value into column "id".

The error is because we changed the primary key type. We'll fix this next.


### Delete generateUserId

Delete the function generateUserId because the database will generate the user id automatically:

```ts
function generateUserId() {
	// ID with 120 bits of entropy, or about the same as UUID v4.
	const bytes = crypto.getRandomValues(new Uint8Array(15));
	const id = encodeBase32LowerCase(bytes);
	return id;
}
```

Delete this line too:

```ts
const userId = generateUserId();
```


### Register with identity

We need to fix the Lucia "register" functionality because we changed the user id from text (which was generated by Lucia) to integer generated always as identity (which is generated by the database). 

To do this, we edit the `db.insert` call, to remove the user id, and also to return the user new record so we learn the user id.


From:

```ts
await db.insert(table.user).values({ id: userId, username, passwordHash });
```

Into:

```
const results = await db.insert(table.user).values({ username, passwordHash }).returning();
const user = results.at(0);
if (user == undefined) throw new Error('user is undefined');
```


### Fix createSession

Edit the file [`src/lib/server/auth.ts`](src/lib/server/auth.ts).

Change the createSession function signature line.

From:

```ts
export async function createSession(token: string, userId: string) {
```

Into:

```ts
export async function createSession(token: string, userId: number) {
```

Remove the line with the sessionId.

From:

```ts
const session: table.Session = {
    id: sessionId,
    userId,
```

Into:

```ts
const session: table.Session = {
    userId,
};
```


### Create a user via SQL

To create a user via SQL, look at the Lucia login file [`src/routes/demo/lucia/login/+page.server.ts`](src/routes/demo/lucia/login/+page.server.ts).

This line shows the password hash algorithm is argon2:

```ts
import { hash, verify } from '@node-rs/argon2';
```

This line converts plain text into a password hash:

```ts
const passwordHash = await hash(password, {
```

This line validates the database record user's password hash with the web browser user's password form field plain text:

```ts
const validPassword = await verify(existingUser.passwordHash, password, {
```

To generate a password using a command line node repl, we can use the same kind of code.

Run:

```sh
node
```

Run:

```js
const { hash, verify } = await import("@node-rs/argon2");
let plainText = "secret";
console.log(plainText);
let cryptText = await hash(plainText, {
    memoryCost: 19456,
    timeCost: 2,
    outputLen: 32,
    parallelism: 1
});
console.log(cryptText);
let isValid = await verify(cryptText, plainText, {
    memoryCost: 19456,
    timeCost: 2,
    outputLen: 32,
    parallelism: 1
});
console.log(isValid);
```

Output:

```
secret
$argon2id$v=19$m=19456,t=2,p=1$gnPDENU4HSDqjiSXNmwjtQ$rb2rZCEcM+OGerU1Mk02+P0bXY+XMPgy9jJ0dakEqdo
true
```

Run SQL:

```sql
INSERT INTO "user" (
    username, 
    password_hash
) 
VALUES (
    'guest', 
    '$argon2id$v=19$m=19456,t=2,p=1$gnPDENU4HSDqjiSXNmwjtQ$rb2rZCEcM+OGerU1Mk02+P0bXY+XMPgy9jJ0dakEqdo'
); 
```

Vet SQL:

```sql
SELECT * FROM "user";
 id | age | username |                                        password_hash                                         
----+-----+----------+----------------------------------------------------------------------------------------------
  1 |     | guest    | $argon2id$v=19$m=19456,t=2,p=1$gnPDENU4HSDqjiSXNmwjtQ$rb2rZCEcM+OGerU1Mk02+P0bXY+XMPgy9jJ0dakEqdo
```
